name: CompareToSingle_v2_LOCAL
on:
  workflow_dispatch:
    inputs:
      CSV_GLOB:
        description: Glob to detect the CSV (default matches standard ETHUSDT 1min)
        required: true
        default: "**/*ETHUSDT*1min*2020*2025*.csv"
        type: string
      PY:
        description: Python version
        required: true
        default: "3.11"
        type: choice
        options:
          - "3.11"
          - "3.10"
      OS:
        description: Runner OS
        required: true
        default: "ubuntu-latest"
        type: choice
        options:
          - ubuntu-latest
      PIN_STRICT:
        description: Enforce pinned SHAs (true or false)
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

env:
  CODE_ZIP: strategy_v2_codepack_v2.1.3.zip
  DATA_ZIP: ETHUSDT_1min_2020_2025.zip
  CHECKOUT_SHA: 08c6903cd8c0fde910a37f88322edcfb5dd907a8
  SETUP_PYTHON_SHA: a26af69be951a213d495a4c3e4e4022e16d87065
  UPLOAD_ARTIFACT_SHA: ea165f8d65b6e75b540449e92b4886f43607fa02

jobs:
  compare:
    runs-on: ${{ inputs.OS }}
    steps:
      - name: Validate pinned SHAs (STRICT)
        if: ${{ inputs.PIN_STRICT == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          repos=("actions/checkout" "actions/setup-python" "actions/upload-artifact")
          shas=("${CHECKOUT_SHA}" "${SETUP_PYTHON_SHA}" "${UPLOAD_ARTIFACT_SHA}")
          i=0
          while [ $i -lt ${#repos[@]} ]; do
            repo="${repos[$i]}"
            sha="${shas[$i]}"
            work="v_$i"
            git init "$work"
            cd "$work"
            git remote add origin "https://github.com/${repo}.git"
            git fetch --depth 1 origin "${sha}"
            git cat-file -t "${sha}" | grep -q commit
            cd ..
            rm -rf "$work"
            i=$((i+1))
          done

      - name: Checkout (pinned SHA)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Verify root files exist
        shell: bash
        run: |
          set -euo pipefail
          test -f "${CODE_ZIP}" || { echo "::error::Missing code zip ${CODE_ZIP}"; exit 1; }
          test -f "${DATA_ZIP}" || { echo "::error::Missing data zip ${DATA_ZIP}"; exit 1; }
          test -f "conf/params_champion.yml" || { echo "::error::Missing conf/params_champion.yml"; exit 1; }
          if [ ! -f "conf/params_alt.yml" ]; then
            echo "conf/params_alt.yml not found, creating a conservative alt from champion"
            install -d conf
            python -c 'import yaml; d=yaml.safe_load(open("conf/params_champion.yml")); d["entry"]["p_thr"]["trend"]=0.80; d["entry"]["p_thr"]["range"]=0.80; d["exit"]["min_hold"]=6; yaml.safe_dump(d, open("conf/params_alt.yml","w"))'
          fi

      - name: Prepare
        shell: bash
        run: |
          set -euo pipefail
          install -d dl out/A out/B
          date +%Y%m%d-%H%M%S > RUN_ID_TAG.txt
          echo "RUN_ID_TAG=$(cat RUN_ID_TAG.txt)" >> "$GITHUB_ENV"

      - name: Unzip data and detect CSV
        id: csvdetect
        shell: bash
        run: |
          set -euo pipefail
          unzip -q -o "${DATA_ZIP}" -d data
          shopt -s globstar nullglob
          match=()
          for f in data/**/${{ inputs.CSV_GLOB }}; do
            if [ -f "$f" ]; then match+=("$f"); fi
          done
          if [ "${#match[@]}" -eq 0 ]; then
            echo "::error::CSVDetect"
            echo "No CSV matched glob: ${{ inputs.CSV_GLOB }}"
            exit 1
          fi
          echo "CSV_PATH=${match[0]}" >> "$GITHUB_ENV"

      - name: Setup Python (pinned SHA)
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs.PY }}

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy scikit-learn pyyaml
          fi

      - name: Unzip codepack
        shell: bash
        run: |
          set -euo pipefail
          rm -rf _codepack
          unzip -q -o "${CODE_ZIP}" -d _codepack

      - name: Run A (champion)
        shell: bash
        run: |
          set -euo pipefail
          python backtest/runner_patched.py --data-root data --csv-glob "${{ inputs.CSV_GLOB }}" --params conf/params_champion.yml --outdir out/A
          for f in summary.json gating_debug.json preds_test.csv trades.csv; do
            [ -f "out/A/$f" ] || printf '{}' > "out/A/${f}"
          done

      - name: Run B (alt)
        shell: bash
        run: |
          set -euo pipefail
          python backtest/runner_patched.py --data-root data --csv-glob "${{ inputs.CSV_GLOB }}" --params conf/params_alt.yml --outdir out/B
          for f in summary.json gating_debug.json preds_test.csv trades.csv; do
            [ -f "out/B/$f" ] || printf '{}' > "out/B/${f}"
          done

      - name: Compare summaries
        shell: bash
        run: |
          set -euo pipefail
          python -c 'import json,os; a=json.load(open("out/A/summary.json")) if os.path.exists("out/A/summary.json") else {}; b=json.load(open("out/B/summary.json")) if os.path.exists("out/B/summary.json") else {}; json.dump({"A":a,"B":b}, open("out/compare_summary.json","w"), ensure_ascii=True, indent=2)'

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: compare_local_${{ github.run_id }}_${{ env.RUN_ID_TAG }}
          path: |
            out/A
            out/B
            out/compare_summary.json
          if-no-files-found: warn
